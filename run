#!/usr/bin/env bash
# vi:syntax=sh

APP_NAME="learn_to_code"

######################################## HELP

help(){
  echo "Builder Script for Learn To Code With Godot"
  echo "please use one of the following commands:"
  for i in ${!funcs[@]}; do
    command=${funcs[i]}
    echo "  - ${command/_/:}"
  done
  echo ""
}


######################################## CLEAN

clean_web(){
  rm -rf build/web
  echo "✓ Removed web files"
}


clean(){
  rm -rf build
  mkdir -p build
  touch build/.gdignore
  echo "✓ Removed all builds"
}

######################################## WEB DEV HELPERS

web_python_server(){
  python -m http.server 8000 --directory build/web
}


web_watch(){
  last_time_compiled=0
  throttle_compile=10
  last_time_copied=0
  throttle_copy=1
  dir=${1:-.}
  full_path=$(readlink -f $dir)
  echo "will watch $full_path"
  inotifywait --monitor --recursive --quiet --event modify,move,create,delete --format '%w%f' --includei "\.(js|css|html|gd)" "$dir" | while read FILE
  do
    changed_dir=$(dirname "$FILE")
    base_dir=$(echo "$changed_dir" | cut -d "/" -f2)
    if [ "$base_dir" != "build" ]; then
      now=$(date +%s)
      filename=$(basename "$FILE")
      ext=${FILE##*.}
      if [ "$base_dir" = "html_export" ]; then
        if (($now - $last_time_copied >= $throttle_copy)); then
          echo "will copy $FILE"
          cp "$FILE" "build/web/$filename"
        fi
        last_time_copied=$(date +%s)
      else
        echo "Changes detected in $FILE, will recompile"
        if (($now - $last_time_compiled >= $throttle_compile)); then
          export_any "HTML5" "build/web/index.html"
        fi 
        last_time_compiled=$(date +%s)
      fi
    fi
  done
}

web(){
  clean_web
  export_web
  web_python_server &
  web_watch
}

######################################## EXPORTS

export_any(){
  export_name=$1
  output=$2
  dir=$(dirname "$output")
  mkdir -p "$dir"
  godot --quiet --no-window --export "$export_name" "$output"
  echo "✓ Exported \`$export_name\` build to \`$dir\`"
}


export_web(){
  export_any "HTML5" "build/web/index.html"
  cp -r html_export/static/* "build/web"
  echo "✓ Copied web files to $dir"
}


export_osx(){
  export_any "Mac OSX" "build/osx/$APP_NAME.zip"
}


export_windows(){
  export_any "Windows Desktop" "build/windows/$APP_NAME.exe"
}


export_linux(){
  export_any "Linux/X11" "build/linux/$APP_NAME.x86_64"
}


export(){
  export_web
  export_windows
  export_osx
  export_linux
}

######################################## PUSHING TO ITCH

push(){
  tag=$1
  if [ -z "$tag" ]; then
    echo "You need to specify a build to push, or \`all\`"
    echo "available builds:"
    for d in build/*/ ; do
      build_name=$(basename $d)
      echo "  - $build_name"
    done
    echo "  - all"
    exit 1
  fi
  dir="build/$tag"
  error=0
  if [ ! -d "$dir" ] && [ "$tag" != "all" ]; then
    echo "\`$dir\` does not seem to exist. Did you type the name correctly?"
    error=1
  fi
  if [ -z "$BUTLER_API_KEY" ]; then
    echo "\$BUTLER_API_KEY is a mandatory variable to push to itch"
    error=1
  fi
  if [ -z "$ITCHIO_USERNAME" ]; then
    echo "\$ITCHIO_USERNAME is a mandatory variable to push to itch"
    error=1
  fi
  if [ -z "$ITCHIO_GAME" ]; then
    echo "\$ITCHIO_GAME is a mandatory variable to push to itch"
    error=1
  fi
  if ! command -v butler &> /dev/null; then
    echo "\`butler\` is not installed or not available on \$PATH"
    error=1
  fi
  if [ "$error" -eq "1" ]; then
    exit 1
  fi
  if [ "$tag" == "all" ]; then
    for d in build/*/ ; do
      build_name=$(basename $d)
      butler push "$d" "$ITCHIO_USERNAME/$ITCHIO_GAME":"$build_name"
    done
  else
    butler push "$dir" "$ITCHIO_USERNAME/$ITCHIO_GAME":"$tag"
  fi
}

######################################## BOOTSTRAP

funcs=(`declare -F | awk '{print $NF}' | sort | egrep -v "^_"`)
command=${1/:/_}

if [[ " ${funcs[*]} " =~ " ${command} " ]]; then
  shift
  $command $@
  exit 0
else
  if [[ $command ]]; then
    echo ""
    echo "\`${command}\` isn't a recognized command"
    echo ""
  fi
  help
  exit 1
fi